<% content_for :title, "Incidents" %>

<div class="w-full">
  <% if notice.present? %>
    <p class="py-2 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-md inline-block" id="notice"><%= notice %></p>
  <% end %>

  <div class="flex justify-between items-center">
    <h1 class="font-bold text-4xl">Incidents</h1>
    <% if @asset.present? %>
      <%= link_to "New incident", new_asset_incident_path(@asset),
          class: "rounded-md px-3.5 py-2.5 bg-blue-600 hover:bg-blue-500 text-white block font-medium" %>
    <% end %>
  </div>

  <div class="card mb-4 mt-4">
    <div class="card-body">
      <%= form_with url: request.path, method: :get, local: true, class: "grid grid-cols-1 md:grid-cols-5 gap-3" do %>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <div class="relative">
            <%= select_tag :status,
                  options_for_select([["Any",""],["Open","open"],["Monitoring","monitoring"],["Resolved","resolved"]], params[:status]),
                  class: "select" %>
            <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Severity</label>
          <div class="relative">
            <%= select_tag :severity,
                  options_for_select([["Any",""],["Minor","minor"],["Moderate","moderate"],["Major","major"],["Critical","critical"]], params[:severity]),
                  class: "select" %>
            <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Started from</label>
          <%= date_field_tag :started_from, params[:started_from], class: "input" %>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Started to</label>
          <%= date_field_tag :started_to, params[:started_to], class: "input" %>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
          <%= text_field_tag :q, params[:q], class: "input", placeholder: "Cause or notes..." %>
        </div>

        <div class="md:col-span-5 flex gap-2 pt-1">
          <%= submit_tag "Filter", class: "btn btn-primary" %>
          <%= link_to "Clear", request.path, class: "btn btn-ghost" %>
        </div>
      <% end %>
    </div>
  </div>

  <div id="incidents" class="min-w-full divide-y divide-gray-200 space-y-5 mt-4">
    <% if @incidents.any? %>
      <% @incidents.each do |incident| %>
        <div class="flex flex-col sm:flex-row justify-between items-center gap-3 pb-5 sm:pb-0">
        
          <%= render incident %>

          <div class="w-full sm:w-auto flex items-center gap-2">
            <%= status_badge(incident.status) %>
            <% if incident.respond_to?(:severity) && incident.severity.present? %>
              <%= severity_badge(incident.severity) %>
            <% end %>
          </div>

          <div class="flex gap-2 whitespace-nowrap">
            <%= link_to "Show",
                incident_path(incident),
                class: "px-3 py-1 border-2 border-blue-600 text-blue-600 rounded-lg font-medium
                        hover:bg-blue-600 hover:text-white transition-colors duration-200" %>

            <%= link_to "Edit",
                edit_incident_path(incident),
                class: "px-3 py-1 border-2 border-green-600 text-green-600 rounded-lg font-medium
                        hover:bg-green-600 hover:text-white transition-colors duration-200" %>

            <%= link_to "Destroy",
                incident_path(incident),
                data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this incident?" },
                class: "px-3 py-1 border-2 border-red-600 text-red-600 rounded-lg font-medium
                        hover:bg-red-600 hover:text-white transition-colors duration-200" %>
          </div>



        </div>
      <% end %>
    <% else %>
      <p class="text-center my-10">No incidents found.</p>
    <% end %>
  </div>
</div>
